<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>AIè€³æœºå¯¼è´­äº¤äº’</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #chat-box { height: 60vh; overflow-y: auto; background: #fff; border: 1px solid #dee2e6; padding: 15px; display: flex; flex-direction: column; }
        .user-msg { background: #e3f2fd; align-self: flex-end; margin-left: auto; }
        .ai-msg { background: #f5f5f5; align-self: flex-start; }
        .message { max-width: 80%; margin: 10px; padding: 10px 15px; border-radius: 15px; word-wrap: break-word; }

        #products-area {
            height: 60vh;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            padding: 15px;
            background: #fafafa;
        }
        .product-card { cursor: pointer; transition: all 0.2s; border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .product-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.15); transform: translateY(-2px); }
        .empty-tip { text-align: center; color: #999; margin-top: 50px; }
    </style>
</head>
<body>
<div class="container mt-4">
    <h3 class="text-center mb-4">ä¸AIè€³æœºå¯¼è´­äº¤äº’</h3>

    <div class="row">
        <div class="col-md-8">
            <div id="chat-box" class="mb-3">
                <div class="message ai-msg">æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„ä¸“å±è€³æœºå¯¼è´­ã€‚è¯·é—®æ‚¨å¯¹è€³æœºæœ‰ä»€ä¹ˆå…·ä½“éœ€æ±‚å—ï¼Ÿæ¯”å¦‚é¢„ç®—å¤šå°‘ã€å–œæ¬¢å¤´æˆ´å¼è¿˜æ˜¯å…¥è€³å¼ï¼Ÿ</div>
            </div>
            <form id="input-form">
                <div class="input-group">
                    <input type="text" id="msg-input" class="form-control" placeholder="è¾“å…¥æ‚¨çš„éœ€æ±‚..." required>
                    <button class="btn btn-primary" type="submit">å‘é€</button>
                </div>
            </form>
        </div>

        <div class="col-md-4">
            <h5 class="mb-3">å®æ—¶æ¨è</h5>
            <div id="products-area">
                <div class="empty-tip">æš‚æ— æ¨èå•†å“</div>
            </div>
            <button id="end-interaction" class="btn btn-outline-danger w-100 mt-3">ç»“æŸäº¤äº’å¹¶è¯„ä¼°</button>
        </div>
    </div>
</div>

<script>
    // æ¸²æŸ“å•†å“åˆ—è¡¨çš„æ ¸å¿ƒå‡½æ•°
    function renderProducts(products) {
        const area = document.getElementById('products-area');

        // 1. æ¯æ¬¡è°ƒç”¨æ—¶å…ˆæ¸…ç©ºæ—§å†…å®¹ï¼Œå®ç°â€œå®æ—¶æ›´æ–°â€
        area.innerHTML = '';

        // 2. å¦‚æœå½“å‰è½®æ¬¡æ²¡æœ‰æ¨èå•†å“ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
        if (!products || products.length === 0) {
            area.innerHTML = '<div class="empty-tip">ğŸ‘‚<br>å½“å‰å¯¹è¯æš‚æ— ç‰¹å®šæ¨è<br><small>æ‚¨å¯ä»¥å°è¯•æè¿°å…·ä½“é¢„ç®—æˆ–ç”¨é€”</small></div>';
            return;
        }

        // 3. å¾ªç¯æ¸²æŸ“æ–°å•†å“
        products.forEach(product => {
            const card = document.createElement('div');
            card.className = "mb-3";

            // ç¡®ä¿ product_id å­˜åœ¨ï¼Œç”¨äºåŒ¹é…å›¾ç‰‡è·¯å¾„
            const pid = product.product_id || 'default';
            const imagePath = `/static/images/products/${pid}.jpg`;

            card.innerHTML = `
            <div class="card product-card">
                <img src="${product.image_url}"
                     class="card-img-top p-2"
                     style="height:150px;object-fit:contain;"
                     onerror="this.src='https://via.placeholder.com/150?text=No+Image';">
                <div class="card-body p-2">
                    <h6 class="card-title">${product.product_name}</h6>
                    <p class="card-text">
                        <span class="text-danger">Â¥${product.price}</span><br>
                        ${product.core_function}
                    </p>
                </div>
            </div>
        `;

            // æ·»åŠ ç‚¹å‡»è®°å½•é€»è¾‘
            card.querySelector('.product-card').addEventListener('click', function() {
                fetch('/api/click_product', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({product_id: pid})
                });
                alert(`æ‚¨ç‚¹å‡»äº†ï¼š${product.product_name}`);
            });

            area.appendChild(card);
        });
    }

    // æ¶ˆæ¯å‘é€å¤„ç†
    document.getElementById('input-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const input = document.getElementById('msg-input');
        const text = input.value.trim();
        if (!text) return;

        addMessage(text, 'user');
        input.value = '';

        try {
            const response = await fetch('/api/send', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({msg: text})
            });

            const data = await response.json();

            // 1. æ·»åŠ  AI æ–‡æœ¬å›å¤
            addMessage(data.response, 'ai');

            // 2. æ ¸å¿ƒï¼šå¼ºåˆ¶è°ƒç”¨æ¸²æŸ“å‡½æ•°åŒæ­¥å³ä¾§åŒºåŸŸ
            // æ— è®ºåç«¯è¿”å›çš„æ˜¯ data.products è¿˜æ˜¯ data.product_idsï¼Œéƒ½ä¼ å…¥æ¸²æŸ“
            const productsToShow = data.products || data.product_ids || [];
            renderProducts(productsToShow);

        } catch (error) {
            console.error('å‘é€å¤±è´¥:', error);
            addMessage('ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œè¯·ç¨åå†è¯•ã€‚', 'ai');
        }
    });

    function addMessage(text, sender) {
        const box = document.getElementById('chat-box');
        const div = document.createElement('div');
        div.className = `message ${sender}-msg`;
        div.innerText = text;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    document.getElementById('end-interaction').addEventListener('click', function() {
        if (confirm('ç¡®å®šç»“æŸäº¤äº’å¹¶è¿›å…¥è¯„ä¼°ç¯èŠ‚å—ï¼Ÿ')) {
            window.location.href = '/end';
        }
    });
</script>
</body>
</html>